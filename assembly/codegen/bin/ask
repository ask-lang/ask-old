#!/usr/bin/env node

/* tslint:disable */
var path = require("path");
const tailArgs = process.argv.indexOf("--");
if (~tailArgs) {
  require("child_process").spawnSync(
    process.argv[0],
    process.argv.slice(tailArgs + 1).concat(
      process.argv.slice(1, tailArgs)
    ),
    { stdio: "inherit" }
  );
  return;
}

try { require("source-map-support").install(); } catch (e) { }

const ARGS = [
  "--importMemory",
  "--initialMemory",
  "2",
  "--maximumMemory",
  "16",
  "--noExportMemory",
  "--runtime",
  "half",
  "--use",
  "abort= ",
  "-O2"
]

const asc = module.exports = require("../cli/asc.js");
if (/\ask$/.test(process.argv[1])) {
  let sourcePath = process.argv[2];
  let dirname = path.dirname(sourcePath);
  let abiPath = path.join(dirname, "target", "metadata.json");
  let wasmPath = path.join(dirname, "target", "target.wasm");
  let extensionPath = path.join(dirname, "extension.ts");
  asc.ready.then(() => {

    const preprocessArgs = [sourcePath, ...ARGS];
    preprocessArgs.push("-a", abiPath, "-p", extensionPath)
    process.exitCode = asc.main(preprocessArgs);

    if (process.exitCode == 0) {
      const postprocessArgs = [extensionPath, ...ARGS];
      postprocessArgs.push("-b", wasmPath)
      asc.ready.then(() => process.exitCode = asc.main(postprocessArgs));
    }
  });
}
